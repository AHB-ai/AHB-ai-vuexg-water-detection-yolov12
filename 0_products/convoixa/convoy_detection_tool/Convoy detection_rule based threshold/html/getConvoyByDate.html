
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Convoy Analysis</title><meta name="generator" content="MATLAB 8.3"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-02-03"><meta name="DC.source" content="getConvoyByDate.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Convoy Analysis</h1><!--introduction--><pre>This function is the core of the convoy analysis, the output of this function is the extracted convoy results in a MATLAB format.</pre><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">I/O</a></li><li><a href="#2">Code</a></li><li><a href="#13">Linked Functions</a></li><li><a href="#14">Navigation</a></li><li><a href="#15">Author</a></li></ul></div><h2>I/O<a name="1"></a></h2><div><ul><li>INPUT:</li></ul></div><p>
<table border=2>
<tr><td><b>date</b></td><td>the date of the search query in a format of dd-mm-yyyy.</td></tr>
<tr><td><b>anprMap</b></td><td>this is a static hash map contains essential information of ANPR camera.</td></tr>
<tr><td><b>rawFile</b></td><td>this is the intermediate format of the ANPR reads of the input date.</td></tr>
<tr><td><b>journey_path</b></td><td>this is the absolute path to save the journey data.</td></tr>
<tr><td><b>convoy_path</b></td><td>this is the absolute path to save the convoy results.</td></tr>
<tr><td><b>session_break</b></td><td>this is the threshold of session break in unit of hours.</td></tr>
<tr><td><b>num_in_session</b></td><td>this is the threshold of convoy size.</td></tr>
<tr><td><b>search_window</b></td><td>this is the threshold of search window.</td></tr>
</table>
</p><div><ul><li>OUTPUT:</li></ul></div><p>
<table border=2>
<tr><td><b>convoyMap</b></td><td>the convoy results are saved in a hashmap, the key is the combination of two VRMs. </td></tr>
</table>
</p><h2>Code<a name="2"></a></h2><pre class="codeinput"><span class="keyword">function</span> convoyMap = getConvoyByDate(date, anprMap, rawFile, journey_path, convoy_path, session_break, num_in_session, search_window)
</pre><pre class="codeinput">convoyFile = [convoy_path <span class="string">'\'</span> date <span class="string">'_export.mat'</span>];
journeyFile = [journey_path <span class="string">'\'</span> date <span class="string">'_journey.mat'</span>];
</pre><p>Detect if the convoy results for this specfic date is avaiable, if yes, load the convoy results, if not perform the following processing.</p><pre class="codeinput"><span class="keyword">if</span> ~exist(convoyFile, <span class="string">'file'</span>)
</pre><p>Load intermediate data format of ANPR reads.</p><pre class="codeinput">    display(<span class="string">'Loading raw data...'</span>);
    load(rawFile);
    display(<span class="string">'Extracting journey information...'</span>);
</pre><p>Call function to detect if the journey information is avaiable, if not, perform extraction of journey. See <a href="..\html\singleJourney.html">Journey Extraction</a></p><pre class="codeinput">    [journeyMap] = singleJourney(output, journeyFile, journey_path);
</pre><p>Filter journey data using convoy size threshold to reduce the data size for further processing. See <a href="..\html\filterJourneyData.html">Journey Filtering</a></p><pre class="codeinput">    display(<span class="string">'Filtering journey data...'</span>);
    dataMap = filterJourneyData(journeyMap, num_in_session);
    display(<span class="string">'Journey data is ready !'</span>);
</pre><p>Define session of a journey using session break threshold. See <a href="..\html\singelSession.html">Session Detection</a></p><pre class="codeinput">    display(<span class="string">'Start session detection...'</span>);
    [single_sessionMap] = singleSession(dataMap, session_break, num_in_session);
    display(<span class="string">'Single vehicle session data is ready !'</span>);
</pre><p>Search vehicles travelling together for a certain period of time using search window threshold. Firstly, the program will detect if the parallel matlab pool is activited, if yes, parfor loop will be used for parallel computing, if not, for loop will be used to conduct convoy analysis. See <a href="..\html\search_par.html">Convoy Analysis Initiating</a></p><pre class="codeinput">    display(<span class="string">'Searching convoy session...'</span>);
    threshold_delt = search_window*60;
    data = output.data;
    index = output.index;
    key = keys(index);
    camMap = index(key{1});
    t0 = 734139;
    N = length(single_sessionMap);
    keySet = keys(single_sessionMap);
    pairMapList = cell(1,N);
    <span class="keyword">if</span> isempty(gcp(<span class="string">'nocreate'</span>))
        <span class="keyword">for</span> ii=1:N
            pairMapList{ii} = search_par(ii, single_sessionMap, single_sessionMap, keySet, data, t0, camMap, anprMap, threshold_delt);
        <span class="keyword">end</span>
    <span class="keyword">else</span>
        <span class="keyword">parfor</span> ii=1:N
            pairMapList{ii} = search_par(ii, single_sessionMap, single_sessionMap, keySet, data, t0, camMap, anprMap, threshold_delt);
        <span class="keyword">end</span>;
    <span class="keyword">end</span>
</pre><p>Final step is to filter and refile convoy result. The convoy results are saved in a hash map structure, and also be saved locally. See <a href="..\html\refineConvoy.html">Refining Convoy Results</a></p><pre class="codeinput">    pairMap = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>,<span class="string">'ValueType'</span>,<span class="string">'any'</span>);
    <span class="keyword">for</span> i=1:length(pairMapList)
        map = pairMapList{i};
        key = keys(map);
        <span class="keyword">for</span> j=1:length(key)
            pairMap(key{j}) = map(key{j});
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    convoyMap = refineConvoy(pairMap, num_in_session, anprMap);
    save([convoy_path <span class="string">'\'</span> date <span class="string">'_export.mat'</span>],<span class="string">'convoyMap'</span>);
    display(<span class="string">'Convoy analysis is done.'</span>);
</pre><pre class="codeinput"><span class="keyword">else</span>
    load(convoyFile);
<span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><h2>Linked Functions<a name="13"></a></h2><div><ul><li>See: <a href="..\html\singleJourney.html">Journey Extraction</a></li><li>See: <a href="..\html\filterJourneyData.html">Journey Filtering</a></li><li>See: <a href="..\html\singelSession.html">Session Detection</a></li><li>See: <a href="..\html\search_par.html">Convoy Analysis Initiating</a></li><li>See: <a href="..\html\refineConvoy.html">Refining Convoy Results</a></li></ul></div><h2>Navigation<a name="14"></a></h2><div><ul><li>Back to <a href="..\html\main.html">Convoy Analysis Tool</a></li><li>Go to <a href="http://www.surrey.ac.uk/cs/research/msf/projects/polarbear_pattern_of_life_anpr_behaviour_extraction_analysis_and_recognition.htm">Project page</a></li></ul></div><h2>Author<a name="15"></a></h2><pre>Haiyue Yuan, 01.2016, Depatment of Computer Science, University of Surrey</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Convoy Analysis
%  This function is the core of the convoy analysis, the output of this function is the extracted convoy results in a MATLAB format.

%%
%% I/O
% * INPUT:
%
% <html>
% <table border=2>
% <tr><td><b>date</b></td><td>the date of the search query in a format of dd-mm-yyyy.</td></tr>
% <tr><td><b>anprMap</b></td><td>this is a static hash map contains essential information of ANPR camera.</td></tr>
% <tr><td><b>rawFile</b></td><td>this is the intermediate format of the ANPR reads of the input date.</td></tr>
% <tr><td><b>journey_path</b></td><td>this is the absolute path to save the journey data.</td></tr>
% <tr><td><b>convoy_path</b></td><td>this is the absolute path to save the convoy results.</td></tr>
% <tr><td><b>session_break</b></td><td>this is the threshold of session break in unit of hours.</td></tr>
% <tr><td><b>num_in_session</b></td><td>this is the threshold of convoy size.</td></tr>
% <tr><td><b>search_window</b></td><td>this is the threshold of search window.</td></tr>
% </table>
% </html>
%
% * OUTPUT:
%
% <html>
% <table border=2>
% <tr><td><b>convoyMap</b></td><td>the convoy results are saved in a hashmap, the key is the combination of two VRMs. </td></tr>
% </table>
% </html>
%
%% Code
function convoyMap = getConvoyByDate(date, anprMap, rawFile, journey_path, convoy_path, session_break, num_in_session, search_window)
convoyFile = [convoy_path '\' date '_export.mat'];
journeyFile = [journey_path '\' date '_journey.mat'];
%%
% Detect if the convoy results for this specfic date is avaiable, if yes,
% load the convoy results, if not perform the following processing. 
if ~exist(convoyFile, 'file')
    %% 
    % Load intermediate data format of ANPR reads.
    display('Loading raw data...');        
    load(rawFile);
    display('Extracting journey information...');
    %%
    % Call function to detect if the journey information is avaiable, if not, perform
    % extraction of journey.
    % See
    % <..\html\singleJourney.html Journey Extraction>  
    [journeyMap] = singleJourney(output, journeyFile, journey_path);

    %%
    % Filter journey data using convoy size threshold to reduce the data
    % size for further processing.
    % See
    % <..\html\filterJourneyData.html Journey Filtering>
    display('Filtering journey data...');
    dataMap = filterJourneyData(journeyMap, num_in_session);
    display('Journey data is ready !');
    %%
    % Define session of a journey using session break threshold.
    % See
    % <..\html\singelSession.html Session Detection>
    display('Start session detection...');
    [single_sessionMap] = singleSession(dataMap, session_break, num_in_session);
    display('Single vehicle session data is ready !');
    %% 
    % Search vehicles travelling together for a certain period of time
    % using search window threshold. Firstly, the program will detect if
    % the parallel matlab pool is activited, if yes, parfor loop will be used
    % for parallel computing, if not, for loop will be used to conduct
    % convoy analysis.
    % See
    % <..\html\search_par.html Convoy Analysis Initiating>
    display('Searching convoy session...');
    threshold_delt = search_window*60;
    data = output.data;
    index = output.index;
    key = keys(index);
    camMap = index(key{1});
    t0 = 734139;
    N = length(single_sessionMap);
    keySet = keys(single_sessionMap);
    pairMapList = cell(1,N);
    if isempty(gcp('nocreate'))
        for ii=1:N
            pairMapList{ii} = search_par(ii, single_sessionMap, single_sessionMap, keySet, data, t0, camMap, anprMap, threshold_delt);
        end
    else
        parfor ii=1:N
            pairMapList{ii} = search_par(ii, single_sessionMap, single_sessionMap, keySet, data, t0, camMap, anprMap, threshold_delt);
        end;
    end        
    %%
    % Final step is to filter and refile convoy result. The convoy results
    % are saved in a hash map structure, and also be saved locally. 
    % See
    % <..\html\refineConvoy.html Refining Convoy Results>
    pairMap = containers.Map('KeyType','char','ValueType','any');
    for i=1:length(pairMapList)
        map = pairMapList{i};
        key = keys(map);
        for j=1:length(key)
            pairMap(key{j}) = map(key{j});
        end
    end
    convoyMap = refineConvoy(pairMap, num_in_session, anprMap);
    save([convoy_path '\' date '_export.mat'],'convoyMap');
    display('Convoy analysis is done.');
else
    load(convoyFile);
end
end

%% Linked Functions
% * See:
% <..\html\singleJourney.html Journey Extraction>
% * See:
% <..\html\filterJourneyData.html Journey Filtering>
% * See:
% <..\html\singelSession.html Session Detection>
% * See:
% <..\html\search_par.html Convoy Analysis Initiating>
% * See:
% <..\html\refineConvoy.html Refining Convoy Results>

%% Navigation
% * Back to 
% <..\html\main.html Convoy Analysis Tool>
% * Go to
% <http://www.surrey.ac.uk/cs/research/msf/projects/polarbear_pattern_of_life_anpr_behaviour_extraction_analysis_and_recognition.htm Project page> 


%% Author
%  Haiyue Yuan, 01.2016, Depatment of Computer Science, University of Surrey
%%

##### SOURCE END #####
--></body></html>