
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Conversion Interface</title><meta name="generator" content="MATLAB 8.3"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2016-02-09"><meta name="DC.source" content="convertExcel2Intermediate.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Conversion Interface</h1><!--introduction--><pre>This is the interface enables the user to put search queries for converting raw ANPR data.</pre><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">I/O</a></li><li><a href="#2">Code</a></li><li><a href="#17">Linked Functions</a></li><li><a href="#18">Navigation</a></li><li><a href="#19">Author</a></li></ul></div><h2>I/O<a name="1"></a></h2><div><ul><li>INPUT:</li></ul></div><p>
<table border=2>
<tr><td><b>data_dir</b></td><td>the path of raw ANPR data from Data wharehouse</td></tr>
<tr><td><b>jar_dir</b></td><td>the path of external java library</td></tr>
<tr><td><b>date_start</b></td><td>the starting date for converting raw ANPR data</td></tr>
<tr><td><b>date_end</b></td><td>the ending date for converting raw ANPR data</td></tr>
<tr><td><b>output_dir</b></td><td>the path to store the converted ANPR data, and intermediate data</td></tr>
<tr><td><b>camList</b></td><td>is used to organise data by camera group</td></tr>
<tr><td><b>interfile</b></td><td>the intermediate file that describes the format of converted data.</td></tr>
</table>
</p><h2>Code<a name="2"></a></h2><pre class="codeinput"><span class="keyword">function</span> convertExcel2Intermediate(data_dir, jar_dir, date_start, date_end, output_dir, camList, interfile)
</pre><p>Build hash map to store path information for further quick access See <a href="..\html\build_path_map.html">Build Path</a></p><pre class="codeinput">pathMap = containers.Map(<span class="string">'KeyType'</span>,<span class="string">'char'</span>,<span class="string">'ValueType'</span>,<span class="string">'any'</span>);
pathMap = build_path_map(pathMap, data_dir);
results_folder = [output_dir <span class="string">'\converted ANPR reads'</span>];
<span class="keyword">if</span> ~exist(results_folder, <span class="string">'file'</span>)
    mkdir(output_dir, <span class="string">'converted ANPR reads'</span>);
<span class="keyword">end</span>
</pre><p>Add paths of external java library to MATLAB environment</p><pre class="codeinput">importJAR([jar_dir <span class="string">'\'</span>]);
</pre><p>Define path to store intermediate data</p><pre class="codeinput">inter_folder = [output_dir <span class="string">'\intermediate'</span>];
<span class="keyword">if</span> ~exist(inter_folder, <span class="string">'file'</span>)
    mkdir(output_dir, <span class="string">'intermediate'</span>);
<span class="keyword">end</span>
camGroup_folder =  [output_dir <span class="string">'\camera groups'</span>];
<span class="keyword">if</span> ~exist(camGroup_folder, <span class="string">'file'</span>)
    mkdir(output_dir, <span class="string">'camera groups'</span>);
<span class="keyword">end</span>
</pre><p>Get all dates between starting date and ending date of search</p><pre class="codeinput">dateList = getDates(date_start, date_end);
length_dateList = length(dateList);
</pre><pre class="codeinput"><span class="keyword">for</span> i=1:length_dateList
    date = dateList{i};
    <span class="keyword">if</span> ~isempty(date)
        <span class="keyword">if</span> isKey(pathMap, date)
</pre><pre class="codeinput">            path_lists = pathMap(date);
            idx_file = fullfile(inter_folder, [str2date(date) <span class="string">'.mat'</span>]);
            csv_file = fullfile(inter_folder, [str2date(date) <span class="string">'.csv'</span>]);
</pre><p>Detect if the index file and intermediate file exists, and call the corresponding functions to convert raw data</p><pre class="codeinput">            <span class="keyword">if</span> exist(idx_file, <span class="string">'file'</span>) &amp;&amp; exist(csv_file, <span class="string">'file'</span>)
</pre><p>If the index file and intermediate file exists, call gatherData_byCam to retrieve data. See <a href="..\html\gatherData_byCam.html">Retrieve Data by Camera Group</a></p><pre class="codeinput">                [new_data, dateMap] = gatherData_byCam(camList, date, camGroup_folder);
</pre><pre class="codeinput">            <span class="keyword">end</span>
            <span class="keyword">if</span> ~exist(idx_file, <span class="string">'file'</span>) || ~exist(csv_file, <span class="string">'file'</span>)
</pre><p>If the index file or intermediate file does not exist, the program calls three functions to convert the data. The program calls convertRaw to convert the data, and followed by calling organiseDataByCam to organise the data by its camera group for quick access, and lastly the program calls gatherData_byCam to retrieve data See: <a href="..\html\convertRaw.html">Conversion;</a> See: <a href="..\html\organiseDataByCam.html">Organise Data by Camera Group;</a> See: <a href="..\html\gatherData_byCam.html">Retrieve Data by Camera Group.</a></p><pre class="codeinput">                [output_data] = convertRaw(date, path_lists, inter_folder, interfile);
                organiseDataByCam(output_data, date, camGroup_folder)
                [new_data, dateMap] = gatherData_byCam(camList, date, camGroup_folder);
</pre><pre class="codeinput">            <span class="keyword">end</span>
</pre><p>Save the output to the dedicated path</p><pre class="codeinput">            output = struct;
            output.data = new_data;
            output.index = dateMap;
            save([results_folder <span class="string">'\'</span> str2date(date) <span class="string">'_export.mat'</span>],<span class="string">'output'</span>);
            clear <span class="string">output</span>;
</pre><pre class="codeinput">        <span class="keyword">else</span>
            fprintf(<span class="string">'Sorry there is no data for this date: ''%s'' in the database'</span>,date);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><pre class="codeinput"><span class="keyword">end</span>
</pre><h2>Linked Functions<a name="17"></a></h2><div><ul><li>See <a href="..\html\build_path_map.html">Build Path</a></li><li>See: <a href="..\html\convertRaw.html">Conversion</a></li><li>See: <a href="..\html\organiseDataByCam.html">Organise Data by Camera Group</a></li><li>See: <a href="..\html\gatherData_byCam.html">Retrieve Data by Camera Group</a></li></ul></div><h2>Navigation<a name="18"></a></h2><div><ul><li>Go to <a href="..\html\main.html">main</a></li><li>Go to <a href="http://www.surrey.ac.uk/cs/research/msf/projects/polarbear_pattern_of_life_anpr_behaviour_extraction_analysis_and_recognition.htm">Project page</a></li></ul></div><h2>Author<a name="19"></a></h2><pre>Haiyue Yuan, 02.2016, Depatment of Computer Science, University of Surrey</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2014a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Conversion Interface
%  This is the interface enables the user to put search queries for converting raw ANPR data.

%%
%% I/O
% * INPUT:
%
% <html>
% <table border=2>
% <tr><td><b>data_dir</b></td><td>the path of raw ANPR data from Data wharehouse</td></tr>
% <tr><td><b>jar_dir</b></td><td>the path of external java library</td></tr>
% <tr><td><b>date_start</b></td><td>the starting date for converting raw ANPR data</td></tr>
% <tr><td><b>date_end</b></td><td>the ending date for converting raw ANPR data</td></tr>
% <tr><td><b>output_dir</b></td><td>the path to store the converted ANPR data, and intermediate data</td></tr>
% <tr><td><b>camList</b></td><td>is used to organise data by camera group</td></tr>
% <tr><td><b>interfile</b></td><td>the intermediate file that describes the format of converted data.</td></tr>
% </table>
% </html>
%
%% Code

function convertExcel2Intermediate(data_dir, jar_dir, date_start, date_end, output_dir, camList, interfile)
%%
% Build hash map to store path information for further quick access
% See
% <..\html\build_path_map.html Build Path>
pathMap = containers.Map('KeyType','char','ValueType','any');
pathMap = build_path_map(pathMap, data_dir);
results_folder = [output_dir '\converted ANPR reads'];
if ~exist(results_folder, 'file')
    mkdir(output_dir, 'converted ANPR reads');
end
%%
% Add paths of external java library to MATLAB environment
importJAR([jar_dir '\']);
%% 
% Define path to store intermediate data
inter_folder = [output_dir '\intermediate'];
if ~exist(inter_folder, 'file')
    mkdir(output_dir, 'intermediate');
end
camGroup_folder =  [output_dir '\camera groups'];
if ~exist(camGroup_folder, 'file')
    mkdir(output_dir, 'camera groups');
end
%%
% Get all dates between starting date and ending date of search
dateList = getDates(date_start, date_end);
length_dateList = length(dateList);
%%
for i=1:length_dateList
    date = dateList{i};
    if ~isempty(date)
        if isKey(pathMap, date)
            path_lists = pathMap(date);
            idx_file = fullfile(inter_folder, [str2date(date) '.mat']);
            csv_file = fullfile(inter_folder, [str2date(date) '.csv']);
            %%
            % Detect if the index file and intermediate file exists, and
            % call the corresponding functions to convert raw data
            if exist(idx_file, 'file') && exist(csv_file, 'file')
                %%
                % If the index file and intermediate file exists, call
                % gatherData_byCam to retrieve data.
                % See
                % <..\html\gatherData_byCam.html Retrieve Data by Camera Group>
                [new_data, dateMap] = gatherData_byCam(camList, date, camGroup_folder);
            end
            if ~exist(idx_file, 'file') || ~exist(csv_file, 'file')
                %%
                % If the index file or intermediate file does not exist,
                % the program calls three functions to convert the data.
                % The program calls convertRaw to convert the data, and
                % followed by calling organiseDataByCam to organise the
                % data by its camera group for quick access, and lastly the
                % program calls gatherData_byCam to retrieve data
                % See:
                % <..\html\convertRaw.html Conversion;>
                % See:
                % <..\html\organiseDataByCam.html Organise Data by Camera Group;>
                % See:
                % <..\html\gatherData_byCam.html Retrieve Data by Camera Group.>
                [output_data] = convertRaw(date, path_lists, inter_folder, interfile);
                organiseDataByCam(output_data, date, camGroup_folder)
                [new_data, dateMap] = gatherData_byCam(camList, date, camGroup_folder);
            end
            %%
            % Save the output to the dedicated path
            output = struct;
            output.data = new_data;
            output.index = dateMap;
            save([results_folder '\' str2date(date) '_export.mat'],'output');
            clear output;
        else
            fprintf('Sorry there is no data for this date: ''%s'' in the database',date);
        end
    end
end
end

%% Linked Functions
% * See
% <..\html\build_path_map.html Build Path>
% * See:
% <..\html\convertRaw.html Conversion>
% * See:
% <..\html\organiseDataByCam.html Organise Data by Camera Group>
% * See:
% <..\html\gatherData_byCam.html Retrieve Data by Camera Group>

%% Navigation
% * Go to 
% <..\html\main.html main> 
% * Go to 
% <http://www.surrey.ac.uk/cs/research/msf/projects/polarbear_pattern_of_life_anpr_behaviour_extraction_analysis_and_recognition.htm Project page> 

%% Author
%  Haiyue Yuan, 02.2016, Depatment of Computer Science, University of Surrey


##### SOURCE END #####
--></body></html>